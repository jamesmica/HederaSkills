<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Cartographie & Veille</title>

  <link rel="icon" href="favicon.png" type="image/png">
  <link rel="stylesheet" href="styles.css" />

  <!-- Leaflet core + clusters + spiderfier -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <script src="https://cdn.jsdelivr.net/npm/overlapping-marker-spiderfier-leaflet@0.2.7/dist/oms.min.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <!-- Export Excel (utilis√© par veille.js et references.js) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
  <!-- Barre d'onglets -->
  <nav class="tabs" aria-label="Navigation des sections">
    <button class="tab-chip active" data-tab="annuaire" aria-controls="view-annuaire">Annuaire</button>
    <button class="tab-chip" data-tab="references" aria-controls="view-references">R√©f√©rences</button>
    <button class="tab-chip" data-tab="veille" aria-controls="view-veille">Veille concurrentielle</button>
  </nav>

  <!-- === VUE : ANNUAIRE (existant) === -->
  <section id="view-annuaire" class="view active" aria-label="Section Annuaire">
    <div id="app">
      <div id="map" aria-label="Carte des collaborateurs"></div>

      <aside id="panel" aria-label="Panneau lat√©ral des filtres et r√©sultats">
        <button id="panelToggle" aria-expanded="true" aria-controls="panel" title="Afficher/Masquer le panneau">‚ü©</button>

        <header class="panel-header">
          <div class="brand">
            <h1>Carte des comp√©tences</h1>
          </div>
        </header>

        <section class="controls">
          <div class="search-row">
            <input id="search" type="search" placeholder="Rechercher (nom, poste, entit√©, comp√©tence‚Ä¶)" autocomplete="off" />
            <button id="clear" class="soft" title="Effacer la recherche" aria-label="Effacer">Effacer</button>
          </div>
          <div class="filters">
            <div class="filters-head">
              <strong>Entit√©s</strong>
              <button id="filtersReset" class="soft" title="R√©initialiser">R√©initialiser</button>
            </div>
            <div id="companies" class="chips" role="group" aria-label="Filtrer par entit√©"></div>
          </div>
        </section>

        <section id="list">
          <ul id="people"></ul>
          <div id="empty" class="hidden">Aucun r√©sultat.</div>
        </section>
      </aside>
    </div>
  </section>

  <!-- === VUE : R√âF√âRENCES (nouvelle carte + panneau d√©di√©) === -->
  <section id="view-references" class="view" aria-label="Section R√©f√©rences">
    <div id="refApp">
      <div id="refMap" aria-label="Carte des r√©f√©rences"></div>

      <aside id="refPanel" aria-label="Panneau des r√©f√©rences">
        <button id="refPanelToggle" aria-expanded="true" aria-controls="refPanel" title="Afficher/Masquer le panneau">‚ü©</button>

        <header class="panel-header">
          <div class="brand">
            <h1>R√©f√©rences</h1>
          </div>
        </header>

        <section class="controls">
          <div class="search-row">
            <input id="refSearch" type="search" placeholder="Rechercher par mots-cl√©s‚Ä¶" autocomplete="off" />
            <button id="refClear" class="soft" title="Effacer">Effacer</button>
          </div>
          <div class="filters">
            <div class="filters-head">
              <strong>Entit√©s</strong>
              <button id="refFiltersReset" class="soft" title="R√©initialiser">R√©initialiser</button>
            </div>
            <div class="chips" id="refFilters"></div>
          </div>
        </section>

        <section id="refList">
          <ul id="refItems"></ul>
          <div id="refEmpty" class="hidden">Aucun √©l√©ment.</div>
        </section>
      </aside>
    </div>
  </section>

  <!-- === VUE : VEILLE CONCURRENTIELLE (UI bas√©e sur veille.js) === -->
  <section id="view-veille" class="view" aria-label="Section Veille concurrentielle">
    <!-- Carte ind√©pendante -->
    <div id="veilleMap" class="hidden" aria-label="Carte des march√©s"></div>

    <!-- Overlay/chips (compteurs & feedbacks) -->
    <div id="veilleOverlay" class="hidden">
      <span id="veilleCount" class="pill muted">Saisissez vos crit√®res puis lancez la recherche.</span>
    </div>

    <!-- Panneau lat√©ral d√©di√© Veille -->
    <aside id="veillePanel" class="hidden" aria-label="Panneau de recherche Veille">
      <!-- ‚¨ÖÔ∏è fl√®che repli identique √† Annuaire -->
      <button id="veillePanelToggle" aria-expanded="true" aria-controls="veillePanel" title="Afficher/Masquer le panneau">‚ü©</button>

      <header class="panel-header">
        <div class="brand">
          <h1>Veille concurrentielle</h1>
        </div>
      </header>

      <!-- Contr√¥les de recherche -->
      <section class="controls">
        <div class="stack">
          <label class="lbl" for="veilleSearch">Recherche plein texte</label>
          <input id="veilleSearch" type="search" placeholder="Objet ou titulaire" autocomplete="off" />
        </div>

        <!-- <div class="stack">
          <label class="lbl" for="awardeeInput">Titulaire(s) (s√©par√©s par des virgules)</label>
          <input id="awardeeInput" type="text" placeholder="En majuscule, sans caract√®res sp√©ciaux" />
        </div> -->

        <div class="grid-2">
          <div class="stack">
            <label class="lbl" for="veilleLimit">Limite r√©sultats</label>
            <select id="veilleLimit">
              <option value="50" selected>50</option>
              <option value="100">100</option>
              <option value="200">200</option>
              <option value="500">500</option>
            </select>
          </div>
          <div class="stack">
            <label class="lbl" for="exportExcel">&nbsp;</label>
            <div class="actions-row">
              <button id="veilleGo" class="btn-primary">Rechercher</button>
              <button id="exportExcel" class="soft">Exporter Excel</button>
              <!-- ‚è≥ spinner de chargement -->
              <span id="veilleSpinner" class="spinner hidden" aria-live="polite" title="Chargement"></span>
            </div>
          </div>
        </div>
      </section>

      <!-- R√©sultats : cartes (style Annuaire) -->
      <section id="veilleResults">
        <ul id="veilleList" class="veille-cards"></ul>
        <div id="veilleEmpty" class="hidden">Aucun r√©sultat.</div>
      </section>
    </aside>
  </section>

  <!-- Modal partag√© (laiss√© en place pour Annuaire) -->
  <div id="modal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="modal-card">
      <button id="modalClose" class="soft icon-only" aria-label="Fermer">‚úï</button>
      <div id="modalBody"></div>
    </div>
  </div>

  <!-- Config des Google Sheets -->
  <script>
    window.__GSHEET_URL__ = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRszYCdjHlFvMHkMvU9j8Mg8CHK6cou5R-PVJULGrNB9a9s3qrcvY2pSuPPwAjxOQ/pub?gid=1426119136&single=true&output=csv";
    window.__REF_GSHEET_URL__ = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRszYCdjHlFvMHkMvU9j8Mg8CHK6cou5R-PVJULGrNB9a9s3qrcvY2pSuPPwAjxOQ/pub?gid=1805966598&single=true&output=csv";
  </script>

  <!-- JS modules -->
  <script src="app.js"></script>
  <script src="veille.js"></script>
  <script src="references.js"></script>

  <!-- Initialisation des onglets + gestion de la navigation -->
  <script>
    (function(){
      let refMapInstance;
      let refInitialized = false;
      
      const byId = (id)=>document.getElementById(id);
      const views = {
        annuaire: byId('view-annuaire'),
        references: byId('view-references'),
        veille: byId('view-veille')
      };
      const maps = {
        annuaire: byId('map'),
        references: byId('refMap'),
        veille: byId('veilleMap')
      };
      const panels = {
        annuaire: byId('panel'),
        references: byId('refPanel'),
        veille: byId('veillePanel')
      };
      const overlayVeille = byId('veilleOverlay');

      function activateTab(name){
        // √©tat visuel des onglets
        document.querySelectorAll('.tab-chip').forEach(b=>{
          b.classList.toggle('active', b.dataset.tab === name);
        });
        // vues
        Object.entries(views).forEach(([k,el])=>{
          el.classList.toggle('active', k === name);
        });
        // cartes/panneaux par section
        if (name === 'annuaire'){
          maps.annuaire.classList.remove('hidden');
          panels.annuaire.classList.remove('hidden');
          // cacher les autres
          maps.references.classList.add('hidden'); panels.references.classList.add('hidden');
          maps.veille.classList.add('hidden'); panels.veille.classList.add('hidden');
          overlayVeille.classList.add('hidden');
        } else if (name === 'references'){
          // init carte + donn√©es R√©f√©rences √† la demande
          if (!refInitialized){
            refInitialized = true;
            if (window.initReferences){
              setTimeout(() => {
                window.initReferences().then(() => {
                  if (window.refMap) {
                    setTimeout(() => { try { window.refMap.invalidateSize(); } catch(e){} }, 50);
                  }
                }).catch(err => {
                  console.error('[R√©f√©rences] Erreur init:', err);
                });
              }, 100);
            }
          }
          
          maps.references.classList.remove('hidden');
          panels.references.classList.remove('hidden');

          maps.annuaire.classList.add('hidden'); panels.annuaire.classList.add('hidden');
          maps.veille.classList.add('hidden'); panels.veille.classList.add('hidden');
          overlayVeille.classList.add('hidden');

          // üîß essentiel pour corriger l'affichage des tiles
          if (window.refMap) {
            setTimeout(() => { 
              try { 
                window.refMap.invalidateSize(); 
              } catch(e){} 
            }, 100);
          }
        } else if (name === 'veille'){
          // laisser veille.js g√©rer l'init de sa map ; on affiche juste le conteneur
          maps.veille.classList.remove('hidden');
          panels.veille.classList.remove('hidden');
          overlayVeille.classList.remove('hidden');

          maps.annuaire.classList.add('hidden'); panels.annuaire.classList.add('hidden');
          maps.references.classList.add('hidden'); panels.references.classList.add('hidden');
          
          // Invalider la carte Veille si elle existe
          if (window.veilleMap) {
            setTimeout(() => { 
              try { 
                window.veilleMap.invalidateSize(); 
              } catch(e){} 
            }, 100);
          }
        }
        
        // Invalider la carte Annuaire quand on y revient
        if (name === 'annuaire' && window.map) {
          setTimeout(() => { 
            try { 
              window.map.invalidateSize(); 
            } catch(e){} 
          }, 100);
        }
      }

      // Onglets
      document.querySelector('.tab-chip[data-tab="annuaire"]').addEventListener('click', (e)=>{
        e.preventDefault();
        activateTab('annuaire');
      });

      // IMPORTANT : on court-circuite le handler "R√©f√©rences" ajout√© par veille.js
      const refBtn = document.querySelector('.tab-chip[data-tab="references"]');
      refBtn.addEventListener('click', (e)=>{
        e.preventDefault();
        e.stopImmediatePropagation(); // emp√™che switchToAnnuaireOrRefs() de veille.js
        activateTab('references');
      });

      // Veille : on laisse veille.js faire son switch (il masque Annuaire),
      // on compl√®te juste l'√©tat visuel des onglets.
      document.querySelector('.tab-chip[data-tab="veille"]').addEventListener('click', ()=>{
        // d√©lai court pour laisser switchToVeille faire son travail puis aligner les onglets
        setTimeout(()=> activateTab('veille'), 0);
      });

      // D√©marrage sur Annuaire
      activateTab('annuaire');
    })();
  </script>
</body>
</html>
